<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>Form Skrining Remaja</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
      rel="stylesheet"
    />
    <style>
      .bg-grey {
        background-color: #f0f0f0; /* Warna abu-abu terang */
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="col-md-4">
        <a href="index.html" class="btn btn-danger shadow">Back to Dashboard</a>
      </div>
      <h2 class="mb-4 mt-4">Form Skrining Remaja</h2>
      <form id="formInput" class="card p-4 shadow bg-white">
        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">Nama</label>
            <input
              type="text"
              id="nama"
              name="nama"
              class="form-control"
              list="namaList"
              autocomplete="off"
              required
            />
            <datalist id="namaList"></datalist>
          </div>
          <div class="col-md-4 mb-3 d-none">
            <label class="form-label">Tanggal</label>
            <input
              type="text"
              id="tanggal"
              name="tanggal"
              class="form-control"
              required
            />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">NIK</label>
            <input type="text" id="nik" name="nik" class="form-control" />
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">Tanggal Lahir</label>
            <input type="text" id="ttl" name="ttl" class="form-control" />
          </div>
          <div class="col-md-2 mb-3">
            <label class="form-label">Usia</label>
            <input
              type="text"
              id="usia"
              name="usia"
              class="form-control bg-grey"
              readonly
            />
          </div>
        </div>

        <div class="row">
          <div class="col-md-4 mb-3">
            <label class="form-label">TB (cm)</label>
            <input type="number" id="tb" name="tb" class="form-control" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">BB (kg)</label>
            <input type="number" id="bb" name="bb" class="form-control" />
          </div>
          <div class="col-md-4 mb-3">
            <label class="form-label">IMT</label>
            <input
              type="number"
              id="imt"
              name="imt"
              step="0.01"
              class="form-control bg-grey"
              readonly
            />
          </div>
        </div>

        <div class="text-end">
          <button class="btn btn-primary shadow" type="submit">Simpan</button>
        </div>
      </form>

      <a href="view.html" class="btn btn-secondary mt-2 shadow">Lihat Data</a>

      <!-- Toast -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 9999">
        <div
          id="toastSuccess"
          class="toast align-items-center text-bg-success border-0"
          role="alert"
        >
          <div class="d-flex">
            <div class="toast-body">Data berhasil disimpan!</div>
            <button
              type="button"
              class="btn-close btn-close-white me-2 m-auto"
              data-bs-dismiss="toast"
            ></button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <!-- Flatpickr JS -->
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database-compat.js"></script>
    <script src="data.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // FIREBASE START
        const firebaseConfig = {
          apiKey: "AIzaSyBZ8oDmqKGfZTWW6v_AoPhrET7m3UrFN2U",
          authDomain: "project1-93feb.firebaseapp.com",
          databaseURL: "https://project1-93feb-default-rtdb.firebaseio.com",
          projectId: "project1-93feb",
          storageBucket: "project1-93feb.firebasestorage.app",
          messagingSenderId: "664823592081",
          appId: "1:664823592081:web:43052220b41afda349bb30",
          measurementId: "G-FXR6QS0BCG",
        };
        // Firebase Start
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);
        // Firebase End

        const namaInput = document.getElementById("nama");
        const namaList = document.getElementById("namaList");

        // Fungsi isi data otomatis berdasarkan input yang cocok persis
        function isiDataOtomatis() {
          const inputNama = namaInput.value.toLowerCase();
          const selected = data.find(
            (item) => item.nama.toLowerCase() === inputNama
          );
          if (selected) {
            document.getElementById("nik").value = selected.nik || "";
            document.getElementById("tanggal").value = selected.tanggal || "";
            document.getElementById("tb").value = selected.tb || "";
            document.getElementById("bb").value = selected.bb || "";
            document.getElementById("imt").value = selected.imt || "";

            // Set tanggal lahir (pastikan formatnya dd-mm-yyyy)
            if (selected.ttl) {
              document.getElementById("ttl").value = selected.ttl;
              hitungUsia(); // Hitung usia otomatis setelah ttl terisi
            }
          }
        }

        let data = []; // Inisialisasi array kosong

        // Ambil data dari Firebase dan isi datalist
        database
          .ref("skrining_remaja")
          .once("value")
          .then((snapshot) => {
            data = []; // Reset dulu
            snapshot.forEach((childSnapshot) => {
              const item = childSnapshot.val();
              data.push(item);

              // Tambahkan ke datalist
              const option = document.createElement("option");
              option.value = item.nama;
              namaList.appendChild(option);
            });
          });
        const tanggalInput = document.getElementById("tanggal");
        const today = new Date();
        const day = String(today.getDate()).padStart(2, "0");
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const year = today.getFullYear();
        const formattedDate = `${day}-${month}-${year}`;
        tanggalInput.value = formattedDate;

        namaInput.addEventListener("input", () => {
          const keyword = namaInput.value.toLowerCase();
          namaList.innerHTML = "";
          const filtered = data.filter((item) =>
            item.nama.toLowerCase().includes(keyword)
          );
          filtered.forEach((item) => {
            const option = document.createElement("option");
            option.value = item.nama;
            namaList.appendChild(option);
          });
          isiDataOtomatis();
        });

        namaInput.addEventListener("change", isiDataOtomatis);

        function hitungIMT() {
          const tb = parseFloat(document.getElementById("tb").value);
          const bb = parseFloat(document.getElementById("bb").value);
          if (tb > 0 && bb > 0) {
            const tbInMeter = tb / 100;
            const imt = bb / (tbInMeter * tbInMeter);
            document.getElementById("imt").value = imt.toFixed(2);
          } else {
            document.getElementById("imt").value = "";
          }
        }

        document.getElementById("tb").addEventListener("input", hitungIMT);
        document.getElementById("bb").addEventListener("input", hitungIMT);

        flatpickr("#ttl", {
          dateFormat: "d-m-Y",
          maxDate: "today",
        });

        function hitungUsia() {
          const ttl = document.getElementById("ttl").value;
          if (ttl) {
            const ttlDate = new Date(ttl.split("-").reverse().join("-"));
            const ageDifMs = Date.now() - ttlDate.getTime();
            const ageDate = new Date(ageDifMs);
            const age = Math.abs(ageDate.getUTCFullYear() - 1970);
            document.getElementById("usia").value = age;
          }
        }

        document.getElementById("ttl").addEventListener("input", hitungUsia);

        // Simpan data
        document
          .getElementById("formInput")
          .addEventListener("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);
            const dataInput = Object.fromEntries(formData.entries());

            // Simpan ke Firebase Realtime Database
            const newDataRef = database.ref("skrining_remaja").push();
            newDataRef
              .set(dataInput)
              .then(() => {
                const toast = new bootstrap.Toast(
                  document.getElementById("toastSuccess")
                );
                toast.show();
                this.reset();
              })
              .catch((error) => {
                console.error("Firebase Error:", error);
              });
          });
      });
    </script>
  </body>
</html>
