<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title>View Data</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="card">
        <div class="card-body shadow">
          <h2 class="mb-4">Data Tersimpan</h2>
          <table class="table table-bordered table-striped" id="dataTable">
            <thead class="table-dark text-center">
              <tr>
                <th>No</th>
                <th>Tanggal Input</th>
                <th>NIK</th>
                <th>Nama Pasien</th>
                <th>Tggl Lahir</th>
                <th>Usia</th>
                <th>Tinggi Badan</th>
                <th>Berat Badan</th>
                <th>IMT</th>
                <th>Option</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <a href="index.html" class="btn btn-secondary mt-2 shadow"
        >Kembali ke Form</a
      >
    </div>

    <script src="data.js"></script>
    <script>
      const tbody = document.querySelector("#dataTable tbody");

      function renderTable() {
        tbody.innerHTML = "";
        data.forEach((item, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${index + 1}.</td>
        <td>${item.tanggal}</td>
        <td>${item.nik}</td>
        <td>${item.nama}</td>
        <td>${item.ttl}</td>
        <td>${item.usia}</td>
        <td>${item.tb}</td>
        <td>${item.bb}</td>
        <td>${item.imt}</td>
        <td>
          <button class="btn btn-sm btn-warning me-1 shadow" onclick="editData(${index})">Edit</button>
          <button class="btn btn-sm btn-danger shadow" onclick="deleteData(${index})">Hapus</button>
        </td>
      `;
          tbody.appendChild(tr);
        });
      }

      function deleteData(index) {
        Swal.fire({
          title: "Yakin hapus data ini?",
          text: "Data akan dihapus permanen",
          icon: "warning",
          showCancelButton: true,
          confirmButtonText: "Ya, hapus!",
          cancelButtonText: "Batal",
        }).then((result) => {
          if (result.isConfirmed) {
            fetch("update.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ action: "delete", index: index }),
            })
              .then((res) => res.json())
              .then((res) => {
                if (res.status === "ok") {
                  data.splice(index, 1);
                  renderTable();
                  Swal.fire("Terhapus!", "Data berhasil dihapus.", "success");
                }
              });
          }
        });
      }

      function editData(index) {
        const current = data[index];
        Swal.fire({
          title: "Edit Data ",
          html: `
              <input id="swal-nama" class="swal2-input" placeholder="Nama" value="${current.nama}">
              <input id="swal-nik" type="number" class="swal2-input" placeholder="Umur" value="${current.nik}">
              <input id="swal-tb" type="number" class="swal2-input" placeholder="Umur" value="${current.tb}">
              <input id="swal-bb" type="number" class="swal2-input" placeholder="Umur" value="${current.bb}">
              <input id="swal-imt" type="number" class="swal2-input" placeholder="Umur" value="${current.imt}">
              `,
          confirmButtonText: "Simpan",
          showCancelButton: true,
          preConfirm: () => {
            return {
              nama: document.getElementById("swal-nama").value,
              //   umur: document.getElementById("swal-umur").value,
              nik: document.getElementById("swal-nik").value,
              tb: document.getElementById("swal-tb").value,
              bb: document.getElementById("swal-bb").value,
              imt: document.getElementById("swal-imt").value,
            };
          },
        }).then((result) => {
          if (result.isConfirmed) {
            const updated = result.value;
            fetch("update.php", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                action: "edit",
                index: index,
                item: updated,
              }),
            })
              .then((res) => res.json())
              .then((res) => {
                if (res.status === "ok") {
                  data[index] = updated;
                  renderTable();
                  Swal.fire("Berhasil!", "Data berhasil diubah.", "success");
                }
              });
          }
        });
      }

      // render data awal
      renderTable();
    </script>
  </body>
</html>
